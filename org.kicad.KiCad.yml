app-id: org.kicad.KiCad
branch: beta
runtime: org.freedesktop.Platform
runtime-version: '21.08'
sdk: org.freedesktop.Sdk
command: kicad
rename-appdata-file: org.kicad.kicad.metainfo.xml
finish-args:
- --device=dri
- --env=LD_LIBRARY_PATH=/app/lib
- --filesystem=home
- --share=ipc
- --share=network
- --socket=x11

add-extensions:
  org.kicad.KiCad.Library:
    version: beta
    directory: extensions/Library
    autodelete: true
    no-autodownload: false
    subdirectories: true
    merge-dirs: template;symbols;footprints;3dmodels

cleanup:
- /include
- /lib/cmake
- /lib/pkgconfig
- /lib/wx
- /lib64
- /share/aclocal
- /share/bakefile
- '*.la'
- '*.a'

modules:
- shared-modules/glu/glu-9.json

- name: glm
  buildsystem: simple
  build-commands:
  - cp -r glm /app/include
  sources:
  - type: archive
    url: https://github.com/g-truc/glm/releases/download/0.9.9.8/glm-0.9.9.8.zip
    sha256: 37e2a3d62ea3322e43593c34bae29f57e3e251ea89f4067506c94043769ade4c

- name: libXmu
  cleanup:
  - /share/doc
  sources:
  - type: archive
    url: https://www.x.org/archive//individual/lib/libXmu-1.1.3.tar.gz
    sha256: 5bd9d4ed1ceaac9ea023d86bf1c1632cd3b172dce4a193a72a94e1d9df87a62e

- name: OCCT
  buildsystem: cmake-ninja
  cleanup:
  - /bin
  - /share/doc
  config-opts:
  - -DCMAKE_BUILD_TYPE=Release
  - -DBUILD_LIBRARY_TYPE=Shared
  - -DBUILD_Inspector=OFF
  - -DBUILD_DOC_Overview=OFF
  - -DBUILD_MODULE_ApplicationFramework=ON
  - -DBUILD_MODULE_DataExchange=ON
  - -DBUILD_MODULE_Draw=OFF
  - -DBUILD_MODULE_FoundationClasses=ON
  - -DBUILD_MODULE_ModelingAlgorithms=ON
  - -DBUILD_MODULE_ModelingData=ON
  - -DBUILD_MODULE_Visualization=ON
  - -DUSE_VTK=OFF
  - -DUSE_TBB=OFF
  - -DINSTALL_FREETYPE=OFF
  - -DINSTALL_SAMPLES=OFF
  - -DINSTALL_TEST_CASES=OFF
  sources:
  - type: archive
    url: https://github.com/tpaviot/oce/releases/download/official-upstream-packages/opencascade-7.5.1.snapshot.tar.gz
    sha256: db6c38dbaddb3f95c4af4234b3f2972d4121b59b99bb07ded06fe4bd212b2aaa

- name: boost
  buildsystem: simple
  build-commands:
  - ./bootstrap.sh --prefix=/app --with-libraries=context,date_time,filesystem,iostreams,locale,program_options,regex,system,thread,test
  - ./b2 -j $FLATPAK_BUILDER_N_JOBS install
  sources:
  - type: archive
    url: https://boostorg.jfrog.io/artifactory/main/release/1.77.0/source/boost_1_77_0.tar.gz
    sha256: 5347464af5b14ac54bb945dc68f1dd7c56f0dad7262816b956138fc53bcc0131

- name: wxWidgets
  cleanup:
  - /bin
  config-opts:
  - --with-opengl
  sources:
  - type: archive
    url: https://github.com/wxWidgets/wxWidgets/releases/download/v3.1.5/wxWidgets-3.1.5.tar.bz2
    sha256: d7b3666de33aa5c10ea41bb9405c40326e1aeb74ee725bb88f90f1d50270a224
  - type: script
    commands:
    - cp -p /usr/share/automake-*/config.{sub,guess} .
    - autoconf -f -B build/autoconf_prepend-include

- python3-wxPython.yml

- name: swig
  buildsystem: autotools
  cleanup:
  - /bin
  - /share
  sources:
  - type: archive
    url: https://sourceforge.net/projects/swig/files/swig/swig-4.0.2/swig-4.0.2.tar.gz
    sha256: d53be9730d8d58a16bf0cbd1f8ac0c0c3e1090573168bfa151b01eb47fa906fc

- name: ngspice
  cleanup:
  - /bin
  - /share/man
  config-opts:
  - --disable-silent-rules
  - --enable-xspice
  - --enable-cider
  - --enable-openmp
  - --with-ngshared
  rm-configure: true
  sources:
  - type: archive
    url: https://downloads.sourceforge.net/project/ngspice/ng-spice-rework/35/ngspice-35.tar.gz
    sha256: c1b7f5c276db579acb3f0a7afb64afdeb4362289a6cab502d4ca302d6e5279ec
  - type: script
    commands:
    - cp -p /usr/share/automake-*/config.{sub,guess} .
    - autoconf -f -B build/autoconf_prepend-include

- name: kicad
  buildsystem: cmake-ninja
  config-opts:
  - -DCMAKE_BUILD_TYPE=RelWithDebInfo
  - -DOCC_INCLUDE_DIR=/app/include/opencascade
  - -DOPENGL_glu_LIBRARY=/app/lib/libGLU.so
  - -DKICAD_BUILD_QA_TESTS=OFF
  - -DKICAD_BUILD_I18N=ON
  - -DKICAD_USE_EGL=ON
  - -DKICAD_USE_OCC=ON
  - -DKICAD_USE_OCE=OFF
  - -DKICAD_LIBRARY_DATA=/app/extensions/Library
  post-install:
  - for f in $FLATPAK_DEST/share/applications/*.desktop; do
      desktop_name="$(basename $f)";
      desktop_app_name="${desktop_name%.desktop}";
      app_name="${desktop_app_name#org.kicad.}";
      if [ "$app_name" = "kicad" ]; then
        desktop-file-edit --set-icon="${FLATPAK_ID}" --set-key=X-Flatpak-RenamedFrom --set-value="${desktop_name};" "$f";
        mv $FLATPAK_DEST/share/applications/{org.kicad.kicad,$FLATPAK_ID}.desktop;
      else
        desktop-file-edit --set-icon="${FLATPAK_ID}.${app_name}" --set-key=X-Flatpak-RenamedFrom --set-value="${desktop_name};" "$f";
        mv $FLATPAK_DEST/share/applications/{org.kicad,$FLATPAK_ID}.${app_name}.desktop;
      fi;
    done;
    unset desktop_name desktop_app_name app_name
  - sed -i "s/\(application-x-kicad-.\+\)/$FLATPAK_ID.\1/" $FLATPAK_DEST/share/mime/packages/kicad-kicad.xml
  - mv $FLATPAK_DEST/share/mime/packages/{kicad,$FLATPAK_ID}-kicad.xml
  - mv $FLATPAK_DEST/share/mime/packages/{kicad,$FLATPAK_ID}-gerbers.xml
  - cd $FLATPAK_DEST/share/icons/hicolor;
    for d in */{apps,mimetypes}; do
      for f in ${d}/*; do
        name="$(basename $f)";
        suffix="${name##*.}";
        if [[ "$name" == kicad.* ]];
          then mv "$f" "${d}/${FLATPAK_ID}.${suffix}";
          else mv "$f" "${d}/${FLATPAK_ID}.${name}";
        fi;
      done;
    done;
    unset name suffix
  sources:
  - type: archive
    url: https://gitlab.com/kicad/code/kicad/-/archive/6.0.0-rc1/kicad-6.0.0-rc1.tar.gz
    sha256: a1fbed57f09361a367c3670b0c802f80877eaadf8c750dd6f981802bdfec5d09
  - type: shell
    commands:
    - sed -i '86i<kudos><kudo>UserDocs</kudo></kudos>' resources/linux/metainfo/org.kicad.kicad.metainfo.xml.in

- name: kicad-doc
  build-commands:
  - find . -type f -exec install -Dm644 "{}" "${FLATPAK_DEST}/{}" \;
  buildsystem: simple
  sources:
  - type: archive
    url: https://kicad-downloads.s3.cern.ch/docs/kicad-doc-5.1.12.tar.gz
    sha256: 8bf34f46758cf631f81f18490310ae7673e343da5eedc5c53192375ee1744479
